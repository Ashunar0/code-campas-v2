# Firestore でデータを更新する（Update）

> 📌 **この記事で学ぶこと**
>
> - updateDoc でデータを更新
> - 部分更新
> - 配列の更新

## updateDoc でデータを更新

**updateDoc** を使うと、既存のドキュメントを更新できます。

```javascript
import { doc, updateDoc } from "firebase/firestore";
import { db } from "./lib/firebase";

const updateTodo = async (id, updates) => {
  const docRef = doc(db, "todos", id);
  await updateDoc(docRef, updates);
};

// 使用例
await updateTodo("abc123", { done: true });
await updateTodo("abc123", { text: "新しいテキスト" });
```

## 完了/未完了の切り替え

```javascript
const toggleTodo = async (id, currentDone) => {
  const docRef = doc(db, "todos", id);
  await updateDoc(docRef, {
    done: !currentDone,
  });
};
```

## テキストの編集

```javascript
const editTodo = async (id, newText) => {
  const docRef = doc(db, "todos", id);
  await updateDoc(docRef, {
    text: newText,
    updatedAt: serverTimestamp(),
  });
};
```

## 配列の更新

### 要素を追加（arrayUnion）

```javascript
import { doc, updateDoc, arrayUnion } from "firebase/firestore";

await updateDoc(doc(db, "posts", "post1"), {
  tags: arrayUnion("React"),
});
// tags: ["JavaScript"] → ["JavaScript", "React"]
```

### 要素を削除（arrayRemove）

```javascript
import { doc, updateDoc, arrayRemove } from "firebase/firestore";

await updateDoc(doc(db, "posts", "post1"), {
  tags: arrayRemove("JavaScript"),
});
// tags: ["JavaScript", "React"] → ["React"]
```

## 数値のインクリメント

```javascript
import { doc, updateDoc, increment } from "firebase/firestore";

await updateDoc(doc(db, "posts", "post1"), {
  likes: increment(1), // +1
});

await updateDoc(doc(db, "posts", "post1"), {
  likes: increment(-1), // -1
});
```

## React での実装

```jsx
import { doc, updateDoc, serverTimestamp } from "firebase/firestore";
import { db } from "./lib/firebase";

function TodoItem({ todo }) {
  const [isEditing, setIsEditing] = useState(false);
  const [editText, setEditText] = useState(todo.text);

  const handleToggle = async () => {
    try {
      await updateDoc(doc(db, "todos", todo.id), {
        done: !todo.done,
      });
    } catch (error) {
      console.error("更新エラー:", error);
    }
  };

  const handleSave = async () => {
    try {
      await updateDoc(doc(db, "todos", todo.id), {
        text: editText,
        updatedAt: serverTimestamp(),
      });
      setIsEditing(false);
    } catch (error) {
      console.error("更新エラー:", error);
    }
  };

  // UI...
}
```

## setDoc との違い

### updateDoc（部分更新）

```javascript
// 指定したフィールドのみ更新
await updateDoc(doc(db, "todos", id), {
  done: true,
});
// { text: "買い物", done: true } ← text は残る
```

### setDoc（上書き）

```javascript
// ドキュメント全体を上書き
await setDoc(doc(db, "todos", id), {
  done: true,
});
// { done: true } ← text は消える！
```

### setDoc + merge オプション

```javascript
// 部分更新として使う
await setDoc(doc(db, "todos", id), { done: true }, { merge: true });
// { text: "買い物", done: true } ← text は残る
```

## まとめ

- **updateDoc** で既存ドキュメントを部分更新
- **arrayUnion/arrayRemove** で配列を更新
- **increment** で数値を増減
- **setDoc** は上書き、`merge: true` で部分更新

## 🎯 やってみよう

> 💡 **ミニ演習**
>
> 1. `toggleTodo` 関数を使って、Todo の完了・未完了を切り替えてみましょう
> 2. `arrayUnion` を使って、Todo にタグを追加してみましょう（例：`tags: ["重要"]`）
> 3. `increment` を使って、いいねカウントを実装してみましょう
>
> **ヒント**: Firebase Console でデータが変わっていることを確認しましょう

---

## 🔗 次のステップ

データ更新ができたら、[Firestore でデータを削除する（Delete）](./05-07_Firestoreでデータを削除する.md) に進みましょう！
