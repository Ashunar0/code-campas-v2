
> ğŸ“Œ **ã“ã®è¨˜äº‹ã§å­¦ã¶ã“ã¨**
>
> - SWR ã¨ã¯
> - Firestore ã¨ SWR ã®çµ„ã¿åˆã‚ã›
> - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

> ğŸ’¡ ã“ã®è¨˜äº‹ã¯**ä»»æ„**ã§ã™ã€‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã®ç™ºå±•çš„ãªå†…å®¹ã§ã™ã€‚

## SWR ã¨ã¯ï¼Ÿ

**SWR**ï¼ˆStale-While-Revalidateï¼‰ã¯ã€Vercel ãŒé–‹ç™ºã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

> ğŸ’¡ **SWR ã®åå‰ã®ç”±æ¥**
>
> **Stale-While-Revalidate**ï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ãªãŒã‚‰å†æ¤œè¨¼ï¼‰ã¨ã„ã† HTTP ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã«ç”±æ¥ã—ã¾ã™ã€‚
> ã¾ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã€è£å´ã§æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦æ›´æ–°ã—ã¾ã™ã€‚

ç‰¹å¾´ï¼š

- è‡ªå‹•ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- è‡ªå‹•å†æ¤œè¨¼
- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®å†å–å¾—
- ã‚¨ãƒ©ãƒ¼ãƒªãƒˆãƒ©ã‚¤

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install swr
```

## åŸºæœ¬çš„ãªä½¿ã„æ–¹

```jsx
import useSWR from "swr";

const fetcher = (url) => fetch(url).then((res) => res.json());

function Profile() {
  const { data, error, isLoading } = useSWR("/api/user", fetcher);

  if (isLoading) return <p>èª­ã¿è¾¼ã¿ä¸­...</p>;
  if (error) return <p>ã‚¨ãƒ©ãƒ¼</p>;

  return <p>ã“ã‚“ã«ã¡ã¯ã€{data.name}ã•ã‚“</p>;
}
```

## Firestore ã¨ã®çµ„ã¿åˆã‚ã›

```jsx
import useSWR from "swr";
import { collection, getDocs, query, where } from "firebase/firestore";
import { db } from "./lib/firebase";
import { useAuth } from "./contexts/AuthContext";

// Firestore ç”¨ fetcher
const fetchTodos = async (userId) => {
  const q = query(collection(db, "todos"), where("userId", "==", userId));
  const snapshot = await getDocs(q);
  return snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
};

function useTodos() {
  const { currentUser } = useAuth();

  const { data, error, isLoading, mutate } = useSWR(
    currentUser ? ["todos", currentUser.uid] : null,
    () => fetchTodos(currentUser.uid)
  );

  return {
    todos: data || [],
    isLoading,
    error,
    mutate, // æ‰‹å‹•ã§å†å–å¾—
  };
}
```

## æ¥½è¦³çš„ UI æ›´æ–°

```jsx
const addTodo = async (text) => {
  const newTodo = {
    id: crypto.randomUUID(),
    text,
    done: false,
    userId: currentUser.uid,
  };

  // 1. æ¥½è¦³çš„ã«æ›´æ–°
  mutate([...todos, newTodo], false);

  try {
    // 2. Firestore ã«è¿½åŠ 
    await addDoc(collection(db, "todos"), {
      text,
      done: false,
      userId: currentUser.uid,
      createdAt: serverTimestamp(),
    });

    // 3. å†å–å¾—ï¼ˆã‚µãƒ¼ãƒãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°ï¼‰
    mutate();
  } catch (error) {
    // 4. å¤±æ•—ã—ãŸã‚‰å…ƒã«æˆ»ã™
    mutate();
  }
};
```

## SWR vs onSnapshot

|              | SWR        | onSnapshot |
| ------------ | ---------- | ---------- |
| ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  | æ‰‹å‹•å†å–å¾— | è‡ªå‹•       |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥   | â­•         | â–³          |
| ã‚ªãƒ•ãƒ©ã‚¤ãƒ³   | â–³          | â­•         |
| ã‚³ã‚¹ãƒˆ       | ä½ã„       | ã‚„ã‚„é«˜ã„   |

- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§é‡è¦–** â†’ onSnapshot
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥é‡è¦–** â†’ SWR

## çµ„ã¿åˆã‚ã›ãƒ‘ã‚¿ãƒ¼ãƒ³

SWR + onSnapshot ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ï¼š

```jsx
import useSWRSubscription from "swr/subscription";
import { collection, onSnapshot, query, where } from "firebase/firestore";

function useTodosRealtime() {
  const { currentUser } = useAuth();

  const { data, error } = useSWRSubscription(
    currentUser ? ["todos", currentUser.uid] : null,
    (key, { next }) => {
      const q = query(
        collection(db, "todos"),
        where("userId", "==", currentUser.uid)
      );

      const unsubscribe = onSnapshot(q, (snapshot) => {
        const todos = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
        next(null, todos);
      });

      return unsubscribe;
    }
  );

  return { todos: data || [], error };
}
```

## ã¾ã¨ã‚

- **SWR** ã§ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã‚’åŠ¹ç‡åŒ–
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**ã¨**è‡ªå‹•å†æ¤œè¨¼**
- **æ¥½è¦³çš„æ›´æ–°**ã§ UX å‘ä¸Š
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ãŒå¿…è¦ãªã‚‰ onSnapshot ã¨çµ„ã¿åˆã‚ã›

## ğŸ¯ ã‚„ã£ã¦ã¿ã‚ˆã†

> ğŸ’¡ **ãƒŸãƒ‹æ¼”ç¿’**
>
> 1. `npm install swr` ã§ SWR ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
> 2. Firestore ã®ãƒ‡ãƒ¼ã‚¿ã‚’ SWR çµŒç”±ã§å–å¾—ã—ã¦ã¿ã¾ã—ã‚‡ã†
> 3. `mutate()` ã‚’ä½¿ã£ãŸå³åº§æ›´æ–°ã‚’è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†
>
> **æ¯”è¼ƒ**: `onSnapshot` ã¨ SWR ã€ãã‚Œãã‚Œã® UX ã®é•ã„ã‚’æ„Ÿã˜ã¦ã¿ã¦ãã ã•ã„

---

## ğŸ”— æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

SWR ãŒã‚ã‹ã£ãŸã‚‰ã€Todo ã‚¢ãƒ—ãƒªã« Firebase ã‚’çµ±åˆã—ã‚ˆã† ã«é€²ã¿ã¾ã—ã‚‡ã†ï¼
