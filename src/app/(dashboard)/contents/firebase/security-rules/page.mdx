
> 📌 **この記事で学ぶこと**
>
> - Firestore セキュリティルールとは
> - 基本的なルールの書き方
> - 認証とデータ所有権のチェック

> 💡 この記事は**任意**ですが、本番運用では必須の知識です。

## セキュリティルールとは？

**セキュリティルール**は、Firestore へのアクセスを制御する仕組みです。

クライアント側のチェックは突破される可能性があるため、**サーバー側（ルール）でも必ずチェック**します。

## テストモードの問題

Firebase Console で「テストモード」を選ぶと、以下のルールになります：

```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
```

**誰でも読み書きできてしまう！**（危険）

## 基本的なルール

### 認証済みユーザーのみ

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /todos/{todoId} {
      allow read, write: if request.auth != null;
    }
  }
}
```

### 自分のデータのみ

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /todos/{todoId} {
      // 読み取り：認証済み & 自分のデータ
      allow read: if request.auth != null
                  && resource.data.userId == request.auth.uid;

      // 作成：認証済み & userId が自分
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;

      // 更新・削除：認証済み & 自分のデータ
      allow update, delete: if request.auth != null
                            && resource.data.userId == request.auth.uid;
    }
  }
}
```

## キーワード解説

| キーワード              | 意味                       |
| ----------------------- | -------------------------- |
| `request.auth`          | 認証情報（null = 未認証）  |
| `request.auth.uid`      | ログイン中のユーザー ID    |
| `resource.data`         | 既存のドキュメントのデータ |
| `request.resource.data` | 送信されてきたデータ       |

> 💡 **request と resource の違い**
>
> - **request**: 今リクエストされている情報（認証情報、送信されたデータ）
> - **resource**: 既にデータベースに存在するドキュメントの情報
>
> 例：`create` 時は `resource` は存在しないので `request.resource.data` を使います。

## Storage のルール

```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // users/{userId}/ 配下は本人のみ
    match /users/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null
                         && request.auth.uid == userId;
    }

    // images/ は認証済みなら誰でも読み書き可
    match /images/{allPaths=**} {
      allow read, write: if request.auth != null;
    }
  }
}
```

## ルールの設定方法

1. Firebase Console を開く
2. **「Firestore Database」** → **「ルール」** タブ
3. ルールを編集
4. **「公開」** をクリック

{/*
📸 画像メモ: セキュリティルール編集画面
*/}

## ルールのテスト

Firebase Console の **「ルールプレイグラウンド」** でテストできます。

1. シミュレーションタイプを選択（get, list, create 等）
2. 認証状態を設定
3. パスとデータを入力
4. 「実行」でテスト

## よくあるパターン

### users コレクション

```javascript
match /users/{userId} {
  // 読み取り：誰でも
  allow read: if true;

  // 書き込み：本人のみ
  allow write: if request.auth != null
               && request.auth.uid == userId;
}
```

### posts コレクション

```javascript
match /posts/{postId} {
  // 読み取り：誰でも
  allow read: if true;

  // 作成：認証済み
  allow create: if request.auth != null;

  // 更新・削除：作成者のみ
  allow update, delete: if request.auth != null
                        && resource.data.authorId == request.auth.uid;
}
```

## まとめ

- **テストモードは開発用**、本番では危険
- `request.auth` で認証チェック
- `resource.data.userId` で所有権チェック
- ルールプレイグラウンドでテスト

## 🎯 やってみよう

> 💡 **ミニ演習**
>
> 1. Firebase Console で Firestore の「ルール」タブを開いてください
> 2. 認証済みユーザーのみ読み書きできるルールを設定
> 3. 「ルールプレイグラウンド」でテストしてみましょう
>
> **テスト例**: 認証あり/なしでそれぞれアクセスできるか確認

---

## 🔗 次のステップ

セキュリティルールがわかったら、Firebase Hosting でデプロイ に進みましょう！
