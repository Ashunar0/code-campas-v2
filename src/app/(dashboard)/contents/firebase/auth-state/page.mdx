# èªè¨¼çŠ¶æ…‹ã®ç®¡ç†

> ğŸ“Œ **ã“ã®è¨˜äº‹ã§å­¦ã¶ã“ã¨**
>
> - onAuthStateChanged
> - Context API ã§èªè¨¼çŠ¶æ…‹ã‚’ç®¡ç†
> - useAuth ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯

## onAuthStateChanged

**onAuthStateChanged** ã¯ã€èªè¨¼çŠ¶æ…‹ã®å¤‰åŒ–ã‚’ç›£è¦–ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼ã§ã™ã€‚

```javascript
import { onAuthStateChanged } from "firebase/auth";
import { auth } from "./lib/firebase";

useEffect(() => {
  const unsubscribe = onAuthStateChanged(auth, (user) => {
    if (user) {
      // ãƒ­ã‚°ã‚¤ãƒ³ä¸­
      console.log("ãƒ­ã‚°ã‚¤ãƒ³ä¸­:", user.email);
    } else {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      console.log("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ");
    }
  });

  return () => unsubscribe();
}, []);
```

## AuthContext ã®ä½œæˆ

ã‚¢ãƒ—ãƒªå…¨ä½“ã§èªè¨¼çŠ¶æ…‹ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã€Context ã‚’ä½¿ã„ã¾ã™ã€‚

> ğŸ’¡ **Context ã¨ã¯ï¼Ÿ**
>
> React ã®çŠ¶æ…‹ç®¡ç†ã®ä»•çµ„ã¿ã§ã€Props ã‚’ä½¿ã‚ãšã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã§ãã¾ã™ã€‚
> Chapter 4 ã§å­¦ã‚“ã å†…å®¹ã§ã™ã€‚å¿˜ã‚Œã¦ã„ãŸã‚‰ [Context API ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç®¡ç†](../04_Reactå¿œç”¨/04-11_ContextAPIã§ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç®¡ç†.md) ã‚’å¾©ç¿’ã—ã¾ã—ã‚‡ã†ã€‚

**src/contexts/AuthContext.jsx**

```jsx
import { createContext, useContext, useState, useEffect } from "react";
import { onAuthStateChanged } from "firebase/auth";
import { auth } from "../lib/firebase";

const AuthContext = createContext();

export function AuthProvider({ children }) {
  const [currentUser, setCurrentUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setCurrentUser(user);
      setLoading(false);
    });

    return unsubscribe;
  }, []);

  const value = {
    currentUser,
    loading,
  };

  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error("useAuth must be used within AuthProvider");
  }
  return context;
}
```

## AuthProvider ã§å›²ã‚€

**src/main.jsx**

```jsx
import { AuthProvider } from "./contexts/AuthContext";

ReactDOM.createRoot(document.getElementById("root")).render(
  <AuthProvider>
    <App />
  </AuthProvider>
);
```

## useAuth ã‚’ä½¿ã†

```jsx
import { useAuth } from "./contexts/AuthContext";

function Header() {
  const { currentUser } = useAuth();

  return (
    <header>
      {currentUser ? (
        <p>ã‚ˆã†ã“ãã€{currentUser.email} ã•ã‚“</p>
      ) : (
        <p>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
      )}
    </header>
  );
}
```

## ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±

`currentUser` ã«ã¯ä»¥ä¸‹ã®æƒ…å ±ãŒå«ã¾ã‚Œã¾ã™ï¼š

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£    | å†…å®¹                   |
| ------------- | ---------------------- |
| uid           | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€æ„ãª ID    |
| email         | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹         |
| displayName   | è¡¨ç¤ºå                 |
| photoURL      | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã® URL |
| emailVerified | ãƒ¡ãƒ¼ãƒ«ç¢ºèªæ¸ˆã¿ã‹       |

```jsx
const { currentUser } = useAuth();

console.log(currentUser.uid); // "abc123..."
console.log(currentUser.email); // "user@example.com"
console.log(currentUser.displayName); // "ç”°ä¸­å¤ªéƒ"
```

## ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®è¡¨ç¤º

èªè¨¼çŠ¶æ…‹ã®ç¢ºèªä¸­ã¯ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

```jsx
export function AuthProvider({ children }) {
  // ...

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã¯childrenã‚’è¡¨ç¤ºã—ãªã„
  return (
    <AuthContext.Provider value={value}>
      {loading ? <div className="loading">èª­ã¿è¾¼ã¿ä¸­...</div> : children}
    </AuthContext.Provider>
  );
}
```

## ã¾ã¨ã‚

- **onAuthStateChanged** ã§èªè¨¼çŠ¶æ…‹ã‚’ç›£è¦–
- **AuthContext** ã§ã‚¢ãƒ—ãƒªå…¨ä½“ã«å…±æœ‰
- **useAuth** ã§ã©ã“ã‹ã‚‰ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã¯ UI ã‚’å¾…æ©Ÿ

## ğŸ¯ ã‚„ã£ã¦ã¿ã‚ˆã†

> ğŸ’¡ **ãƒŸãƒ‹æ¼”ç¿’**
>
> 1. `AuthContext.jsx` ã‚’ä½œæˆã—ã€`main.jsx` ã§ `AuthProvider` ã§å›²ã¿ã¾ã—ã‚‡ã†
> 2. ä»»æ„ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ `useAuth()` ã‚’ä½¿ã£ã¦ `currentUser` ã‚’è¡¨ç¤º
> 3. ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹ã¨ã€è¡¨ç¤ºãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
>
> **ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãŒä¿æŒã•ã‚Œã¾ã™ã‹ï¼Ÿ

---

## ğŸ”— æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

èªè¨¼çŠ¶æ…‹ã®ç®¡ç†ãŒã§ããŸã‚‰ã€[èªè¨¼ã‚¬ãƒ¼ãƒ‰](./05-13_èªè¨¼ã‚¬ãƒ¼ãƒ‰.md) ã«é€²ã¿ã¾ã—ã‚‡ã†ï¼
